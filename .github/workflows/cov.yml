name: Run tests and upload coverage

on: push

jobs:
  test:
    name: Run tests and collect coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        extras: [none, standard, auth, "standard,auth"]
        with-pydantic: [false, true]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install package dependencies (matrix extras)
        run: |
          set -euxo pipefail
          if [ "${{ matrix.extras }}" = "none" ]; then
            python -m pip install .
          else
            python -m pip install ".[${{ matrix.extras }}]"
          fi

      - name: Install test dependencies
        run: python -m pip install pytest pytest-cov pytest-asyncio typing_extensions httpx

      - name: Optionally install pydantic
        if: ${{ matrix.with-pydantic }}
        run: python -m pip install pydantic

      - name: Run tests
        run: |
          set -euxo pipefail
          AUTH=false
          if [[ "${{ matrix.extras }}" == *auth* ]]; then AUTH=true; fi
          PDM="${{ matrix.with-pydantic }}"
          SKIPS=""
          if [ "$AUTH" != "true" ]; then
            SKIPS="not requires_auth"
          fi
          if [ "$PDM" != "true" ]; then
            SKIPS="${SKIPS:+$SKIPS and }not requires_pydantic"
          fi
          # Premier is not installed by default in this matrix
          SKIPS="${SKIPS:+$SKIPS and }not requires_premier"

          if [ -n "$SKIPS" ]; then
            python -m pytest -m "$SKIPS" tests/ --cov=lihil --cov-report html
          else
            python -m pytest tests/ --cov=lihil --cov-report html
          fi

      - name: Upload results to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: python-${{ matrix.python-version }},${{ matrix.extras }},pydantic-${{ matrix.with-pydantic }}
