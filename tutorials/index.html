
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../advanced/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Tutorial - lihil</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Tutorial - lihil" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="./assets/images/social/tutorials.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="None" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Tutorial - lihil" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="./assets/images/social/tutorials.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorial" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="lihil" class="md-header__button md-logo" aria-label="lihil" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            lihil
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  lihil

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  Tutorial

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../advanced/" class="md-tabs__link">
        
  
  
    
  
  Advance

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../testing/" class="md-tabs__link">
        
  
  
    
  
  Testing

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../deployment/" class="md-tabs__link">
        
  
  
    
  
  Deployment

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../minicourse/" class="md-tabs__link">
        
  
  
    
  
  MiniCourse

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../benchmark/" class="md-tabs__link">
        
  
  
    
  
  Benchmark

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../contribute/" class="md-tabs__link">
        
  
  
    
  
  Contribute

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="lihil" class="md-nav__button md-logo" aria-label="lihil" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    lihil
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    lihil
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basics" class="md-nav__link">
    <span class="md-ellipsis">
      Basics
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Enpoint
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enpoint">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Start:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#param-parsing" class="md-nav__link">
    <span class="md-ellipsis">
      Param Parsing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Param Parsing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#param-marks" class="md-nav__link">
    <span class="md-ellipsis">
      Param Marks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#param-analysis-rules" class="md-nav__link">
    <span class="md-ellipsis">
      Param Analysis Rules
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Data validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    <span class="md-ellipsis">
      Constraints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-marks" class="md-nav__link">
    <span class="md-ellipsis">
      Return Marks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Return Marks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#response-with-status-code" class="md-nav__link">
    <span class="md-ellipsis">
      Response with status code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#return-union" class="md-nav__link">
    <span class="md-ellipsis">
      Return Union
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-encoderdecoder" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Encoder/Decoder
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#endpoint-properties" class="md-nav__link">
    <span class="md-ellipsis">
      EndPoint properties
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#route" class="md-nav__link">
    <span class="md-ellipsis">
      Route
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Route">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-an-route" class="md-nav__link">
    <span class="md-ellipsis">
      Defining an route
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Defining an route">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register-endpoint-to-an-route" class="md-nav__link">
    <span class="md-ellipsis">
      register endpoint to an route.
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-an-sub-route" class="md-nav__link">
    <span class="md-ellipsis">
      Defining an sub-route
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-root-route" class="md-nav__link">
    <span class="md-ellipsis">
      The root route
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#websocket" class="md-nav__link">
    <span class="md-ellipsis">
      WebSocket
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WebSocket">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#websocket-vs-http" class="md-nav__link">
    <span class="md-ellipsis">
      websocket vs http
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#middlewares" class="md-nav__link">
    <span class="md-ellipsis">
      Middlewares
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#config-your-app" class="md-nav__link">
    <span class="md-ellipsis">
      Config Your App
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-hanlding" class="md-nav__link">
    <span class="md-ellipsis">
      Error Hanlding
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Hanlding">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#exception-problem-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      Exception-Problem mapping
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-system" class="md-nav__link">
    <span class="md-ellipsis">
      Message System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dependency-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Dependency Injection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dependency Injection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usage-in-lihil" class="md-nav__link">
    <span class="md-ellipsis">
      Usage in lihil
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-a-dependency-with-a-route" class="md-nav__link">
    <span class="md-ellipsis">
      register a dependency with a route
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#declare-dependency-with-endpoint-signature" class="md-nav__link">
    <span class="md-ellipsis">
      Declare dependency with endpoint signature
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Declare dependency with endpoint signature">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-lihiluse-mark-to-declare-a-class-as-a-dependency" class="md-nav__link">
    <span class="md-ellipsis">
      Use lihil.Use mark to declare a class as a dependency.
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-typingannotatedt-usecallable-t-to-declare-a-factory-in-your-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Use typing.Annotated[T, use(Callable[..., T]]) to declare a factory in your endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-ignore-in-return-annotation-to-declare-a-function-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Use Ignore in return annotation to declare a function dependencies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tehcnical-details" class="md-nav__link">
    <span class="md-ellipsis">
      Tehcnical details
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#have-not-found-what-you-are-looking-for" class="md-nav__link">
    <span class="md-ellipsis">
      Have not found what you are looking for?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../advanced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advance
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deployment
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../minicourse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MiniCourse
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Benchmark
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contribute/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contribute
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="tutorial">Tutorial</h1>
<h2 id="basics">Basics</h2>
<h3 id="enpoint">Enpoint</h3>
<p>An <code>endpoint</code> is the most atomic ASGI component in <code>lihil</code>, registered under <code>Route</code> with <code>Route.{http method}</code>, such as <code>Route.get</code>. It defines how clients interact with the resource exposed by the <code>Route</code>.</p>
<p>In the <a href="../minicourse/">ASGI callchain</a> the <code>endpoint</code> is typically at the end.</p>
<p>Let's start with a function that creates a <code>User</code> in database.</p>
<h4 id="quick-start">Quick Start:</h4>
<p>Expose a random function as an endpoint</p>
<p><strong><code>app/users/api.py</code></strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">Struct</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncEngine</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">.users.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">user_sql</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserDB</span><span class="p">(</span><span class="n">UserData</span><span class="p">):</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_engine</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncEngine</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="k">return</span> <span class="n">AsyncEngine</span><span class="p">()</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">UserData</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">AsyncEngine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserDB</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">user_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="n">sql</span> <span class="o">=</span> <span class="n">user_sql</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="k">return</span> <span class="n">UserDB</span><span class="o">.</span><span class="n">from_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
</code></pre></div>
<p>To expose this function as an endpoint:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">Route</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">users_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">users_route</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">get_engine</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">users_route</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">create_user</span><span class="p">)</span>
</code></pre></div>
<p>With just three lines, we:</p>
<ol>
<li>Create a Route with the path "/users".</li>
<li>Register <code>AsyncEngine</code> as a dependency, using <code>get_engine</code> as its factory.</li>
<li>Register create_user as the POST endpoint.</li>
</ol>
<p>You might also use python decorator syntax to register an endpoint</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">users_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nd">@users_route</span><span class="o">.</span><span class="n">post</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">():</span> <span class="o">...</span>
</code></pre></div>
<h4 id="param-parsing">Param Parsing</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">use</span><span class="p">,</span> <span class="n">Ignore</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">NewType</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncConnection</span><span class="p">,</span> <span class="n">AsyncEngine</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_conn</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">AsyncEngine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncConnection</span><span class="p">:</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        <span class="k">yield</span> <span class="n">conn</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="n">UserID</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;UserID&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">user_id_factory</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">UserID</span><span class="p">:</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="k">return</span> <span class="n">UserID</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    <span class="n">user</span><span class="p">:</span> <span class="n">UserData</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">UserID</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">AsyncConnection</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Resp</span><span class="p">[</span><span class="n">UserDB</span><span class="p">,</span> <span class="n">stauts</span><span class="o">.</span><span class="n">Created</span><span class="p">]:</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="n">sql</span> <span class="o">=</span> <span class="n">user_sql</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="k">return</span> <span class="n">UserDB</span><span class="o">.</span><span class="n">from_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="n">users_route</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">get_conn</span><span class="p">)</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="n">users_route</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">user_id_factory</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p>Here,</p>
<ol>
<li><code>user_id</code> will be created by <code>user_id_factory</code> and return a uuid in str.</li>
<li><code>conn</code> will be created by <code>get_conn</code> and return an instance of <code>AsyncConnection</code>, where the the connection will be returned to engine after request.</li>
<li><code>UserDB</code> will be json-serialized, and return a response with content-type being <code>application/json</code>, status code being <code>201</code>.</li>
</ol>
<h5 id="param-marks">Param Marks</h5>
<p>Explicitly declaring a parameter with a param mark tells Lihil to treat it as-is, without further analysis.</p>
<ul>
<li><code>Header[T, H]</code> for header param with type <code>T</code> and header key <code>H</code></li>
<li><code>Cookie[T, C]</code> for cookie param with type <code>T</code> and cookie name <code>C</code></li>
<li><code>Path[T]</code> for path param with type <code>T</code></li>
<li><code>Query[T]</code> for query param with type <code>T</code></li>
<li><code>Body[T]</code> for body param with type <code>T</code></li>
<li><code>Form[T]</code> for body param with content type <code>multipart/from-data</code> and type [T]</li>
<li><code>Use[T]</code> for dependency with type <code>T</code></li>
</ul>
<p><code>Header</code> and <code>Cookie</code> allows your to provide metadata for param parsing,</p>
<p>Use <code>typing.Literal</code> to provide header/cookie name,</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">cred</span><span class="p">:</span> <span class="n">Header</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;User-Credentials&quot;</span><span class="p">]],</span> <span class="n">x_access_token</span><span class="p">:</span> <span class="n">Header</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<ul>
<li>
<p>Here param <code>cred</code> expects a header with key <code>User-Credentials</code>.</p>
</li>
<li>
<p>If key not provided, The kebab case of param name is used, for example, here <code>x_access_token</code> expects a header with key <code>x-access-token</code></p>
</li>
</ul>
<h5 id="param-analysis-rules">Param Analysis Rules</h5>
<p>If a param is not declared with any param mark, the following rule would apply to parse it:</p>
<ul>
<li>If the param name appears in route path, it is interpreted as a path param.</li>
<li>If the param type is a subclass of <code>msgspec.Struct</code>, it is interpreted as a body param.</li>
<li>
<p>If the param type is registered in the route graph, or is a lihil-primitive type, it will be interpered as a dependency and will be resolved by lihil</p>
</li>
<li>
<p>Otherise, it is interpreted as a query param.</p>
</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">Route</span><span class="p">,</span> <span class="n">Payload</span><span class="p">,</span> <span class="n">Use</span><span class="p">,</span> <span class="n">EventBus</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">user_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">UserUpdate</span><span class="p">(</span><span class="n">Payload</span><span class="p">):</span> <span class="o">...</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Engine</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Cache</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="n">user_route</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">Cache</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="nd">@user_route</span><span class="o">.</span><span class="n">put</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">Use</span><span class="p">[</span><span class="n">Engine</span><span class="p">],</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Cache</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="n">EventBus</span><span class="p">):</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="k">return</span> <span class="s2">&quot;ok&quot;</span>
</code></pre></div>
<p>In this example:</p>
<ul>
<li><code>user_id</code> appears in the route path, so it is a path param</li>
<li><code>engine</code> is annotated with the <code>Use</code> mark, so it is a dependency</li>
<li><code>cache</code> is registered in the user_route, so it is also a dependency</li>
<li><code>bus</code> is a lihil-builtin type, it is therefore a dependency as well.</li>
</ul>
<p>Only <code>user_id</code> needs to be provided by the client request, rest will be resolved by lihil.</p>
<p>Since return param is not declared, <code>"ok"</code> will be serialized as json <code>'"ok"'</code>, status code will be <code>200</code>.</p>
<h4 id="data-validation">Data validation</h4>
<p>lihil provide you data validation functionalities out of the box using msgspec.</p>
<h4 id="constraints">Constraints</h4>
<ul>
<li>You might combine <code>typing.Annotated</code> and <code>msgspec.Meta</code> to put constraints on params,</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">all_users</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nd">@all_users</span><span class="o">.</span><span class="n">get</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_users</span><span class="p">(</span><span class="n">numers</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">msgspec</span><span class="o">.</span><span class="n">Meta</span><span class="p">(</span><span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)]):</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="o">...</span>
</code></pre></div>
<p>Here <code>get_user</code> expects a query param <code>numers</code>, an integer with value greater than <code>0</code>.</p>
<ul>
<li>Constraints with structual data</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">Payload</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">msgspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">Meta</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">UnixName</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="nb">str</span><span class="p">,</span> <span class="n">Meta</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;^[a-z_][a-z0-9_-]*$&quot;</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="p">]</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Payload</span><span class="p">):</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="n">name</span><span class="p">:</span> <span class="n">UnixName</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="n">groups</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="n">UnixName</span><span class="p">],</span> <span class="n">Meta</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="n">cpu_limit</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Meta</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">8</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="n">mem_limit</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Meta</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">8192</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1024</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="nd">@all_users</span><span class="o">.</span><span class="n">post</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span> <span class="o">...</span>
</code></pre></div>
<p>Here <code>create_user</code> expects a body param <code>user</code>, a structual data where each field has constraints.</p>
<ul>
<li>Constraints with supported types</li>
</ul>
<p>Checkout <a href="https://jcristharif.com/msgspec/constraints.html">msgspec constraints</a> for more details on specific constraints that you can set on different types.</p>
<h4 id="return-marks">Return Marks</h4>
<p>Often you would like to change the status code, or content type of your endpoint,  to do so, you can use one or a combination of several <code>return marks</code>. for example, to change stauts code:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resp</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">UserData</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Resp</span><span class="p">[</span><span class="n">UserDB</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">Created</span><span class="p">]:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="o">...</span>
</code></pre></div>
<p>Now <code>create_user</code> would return a status code <code>201</code>, instead of the default <code>200</code>.</p>
<p>There are several other return marks you might want to use:</p>
<ul>
<li><code>Json[T]</code> for response with content-type <code>application/json</code></li>
</ul>
<p>Endpoints are assumed to return <code>Json[T]</code> by default, <code>async def f() -&gt; str</code> is the same as  <code>async def f() -&gt; Json[str]</code></p>
<ul>
<li><code>Stream[T]</code> for server sent event with content-type <code>text/event-stream</code></li>
<li><code>Text</code> for response with content-type <code>text/plain</code></li>
<li><code>HTML</code> for response with content-type <code>text/html</code></li>
<li><code>Empty</code> for empty response</li>
</ul>
<p>You can use these return marks just like plain python return type hint</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">Json</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">demo</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span> <span class="o">...</span>
</code></pre></div>
<p>return marks have no runtime/typing effect outside of lihil, your type checker would treat <code>Json[T]</code> as <code>T</code>.</p>
<h5 id="response-with-status-code">Response with status code</h5>
<ul>
<li><code>Resp[T, 200]</code> for response with status code <code>200</code>. where <code>T</code> can be anything json serializable, or another return mark.</li>
</ul>
<p>For instance, in the <code>create_user</code> example, we use <code>Resp[UserDB, status.Created]</code> to declare our return type, here <code>T</code> is <code>UserDB</code>.</p>
<ul>
<li>By default, the return convert is json-serialized, so that it is equiavlent to <code>Resp[Json[UserDB], status.Created]</code>.</li>
<li>If you would like to return a response with content type <code>text/html</code>, you might use <code>HTML</code></li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">hello</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">HTML</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="k">return</span> <span class="s2">&quot;&lt;p&gt;hello, world!&lt;/p&gt;&quot;</span>
</code></pre></div>
<h5 id="return-union">Return Union</h5>
<p>it is valid to return union of multiple types, they will be shown as <code>anyOf</code> schemas in the open api specification.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">User</span> <span class="o">|</span> <span class="n">TemporaryUser</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<h5 id="custom-encoderdecoder">Custom Encoder/Decoder</h5>
<p>You can also use your own customized encoder/decoder for request params and function return.
To use them, annotate your param type with <code>CustomDecoder</code> and your return type with <code>CustomEncoder</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil.di</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomEncoder</span><span class="p">,</span> <span class="n">CustomDecoder</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">user_route</span> <span class="o">=</span> <span class="nd">@Route</span><span class="p">(</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="p">{</span><span class="n">user_id</span><span class="p">})</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="n">user_id</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CustomDecoder</span><span class="p">(</span><span class="n">decode_user_id</span><span class="p">)]</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CustomEncoder</span><span class="p">(</span><span class="n">encode_user_id</span><span class="p">)]:</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="k">return</span> <span class="n">user_id</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">decoder</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">param</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<ul>
<li><code>decoder</code> should expect a single param with type either <code>str</code>, for non-body param, or <code>bytes</code>, for body param, and returns required param type, in the <code>decode_user_id</code> case, it is <code>str</code>.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">encoder</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">param</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<ul>
<li><code>encoder</code> should expect a single param with any type that the endpoint function returns, in the <code>encode_user_id</code> case, it is <code>str</code>, and returns bytes.</li>
</ul>
<h4 id="endpoint-properties">EndPoint properties</h4>
<ul>
<li>Provide extra meta data of endpoint through route decorator.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="p">[</span><span class="n">UserNotFoundError</span><span class="p">,</span> <span class="n">UserInactiveError</span><span class="p">])</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="k">async</span> <span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span> <span class="o">...</span>
</code></pre></div>
<ul>
<li>Endpoint can have these properties:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">errors</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">DetailBase</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">|</span> <span class="nb">type</span><span class="p">[</span><span class="n">DetailBase</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="s2">&quot;Errors that might be raised from the current `endpoint`. These will be treated as responses and displayed in OpenAPI documentation.&quot;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">in_schema</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="s2">&quot;Whether to include this endpoint inside openapi docs&quot;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">to_thread</span><span class="p">:</span> <span class="nb">bool</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="s2">&quot;Whether this endpoint should be run wihtin a separate thread, only apply to sync function&quot;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">scoped</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="s2">&quot;Whether current endpoint should be scoped&quot;</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="n">auth_scheme</span><span class="p">:</span> <span class="n">AuthBase</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="s2">&quot;Auth Scheme for access control&quot;</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="n">tags</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="s2">&quot;OAS tag, endpoints with the same tag will be grouped together&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>- `scoped`: if an endpoint requires any dependency that is an async context manager, or its factory returns an async generator, the endpoint would be scoped, and setting scoped to None won&#39;t change that, however, for an endpoint that is not scoped, setting `scoped=True` would make it scoped.
</code></pre></div>
<ul>
<li>Provide a properties for every endpoint in the route:</li>
</ul>
<p>You might provide default properties when intialize a route,</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil.routing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Route</span><span class="p">,</span> <span class="n">EndpointProps</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="n">default_props</span> <span class="o">=</span> <span class="n">EndpointProps</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="p">[</span><span class="n">UserNotFoundError</span><span class="p">,</span> <span class="n">UserInactiveError</span><span class="p">])</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">prop_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="n">props</span><span class="o">=</span><span class="n">default_props</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>Here <code>default_props</code> would be applied to every endpoint added to <code>prop_route</code>.</li>
<li>endpoint properties provided via route decorator like <code>route.get</code> would override roperties provided by route.</li>
</ul>
<h3 id="route">Route</h3>
<p>When you define a route, you expose a resource through a specific <strong>path</strong> that clients can request. you then add an <code>Endpoint</code> on the route to determin what clients can do with the resource.</p>
<p>Take url <code>https://dontclickme.com/users</code> as an example, path <code>/users</code> would locate resource <code>users</code>.</p>
<h4 id="defining-an-route">Defining an route</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">Route</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="n">users_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
</code></pre></div>
<p>If you have existing <code>lihil.Graph</code> and <code>lihil.MessageRegistry</code> that you would like to use, put then in the route constructor.</p>
<p>This is useful if you keep dependencies and event listeners in separate files, example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">project.users.deps</span><span class="w"> </span><span class="kn">import</span> <span class="n">user_graph</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">project.users.listeners</span><span class="w"> </span><span class="kn">import</span> <span class="n">user_eventregistry</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="n">user_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">uesr_graph</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="n">user_eventregistry</span><span class="p">)</span>
</code></pre></div>
<p>You can also add middlewares to a route if you want them to apply only to that specific route.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.httpsredirect</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPSRedirectMiddleware</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="n">Route</span><span class="p">(</span><span class="n">middlewares</span><span class="o">=</span><span class="p">[</span><span class="n">CORSMiddleware</span><span class="p">])</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">route</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">HTTPSRedirectMiddleware</span><span class="p">)</span>
</code></pre></div>
<h5 id="register-endpoint-to-an-route">register endpoint to an route.</h5>
<p>In previous dicussion, we expose <code>create_user</code> as an endpoint for <code>POST</code> request of <code>users_route</code>.
we can also declare other http methods with similar syntax, this includes:</p>
<ul>
<li><code>GET</code></li>
<li><code>POST</code></li>
<li><code>HEAD</code></li>
<li><code>OPTIONS</code></li>
<li><code>TRACE</code></li>
<li><code>PUT</code></li>
<li><code>DELETE</code></li>
<li><code>PATCH</code></li>
<li><code>CONNECT</code></li>
</ul>
<p>This means that an route can have 0-9 endpoints.</p>
<p>to expose a function for multiple http methods</p>
<ul>
<li>
<p>apply multiple decorators to the function</p>
</li>
<li>
<p>or, equivalently, use <code>Route.add_endpoint</code></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">users_route</span><span class="o">.</span><span class="n">add_endpoint</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>  <span class="n">create_user</span><span class="p">)</span>
</code></pre></div>
<h4 id="defining-an-sub-route">Defining an sub-route</h4>
<p>In previous discussion, we created a route for <code>users</code>, a collection of the user resource,
to expose an specific user resource,</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">user_route</span> <span class="o">=</span> <span class="n">users_route</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nd">@user_route</span><span class="o">.</span><span class="n">get</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span> <span class="o">...</span>
</code></pre></div>
<p>Here,
we define a sub route of <code>users_route</code>, when we include an route into our <code>Lihil</code>, all of its sub-routes will also be included recursively.</p>
<p>Route are unique to path, thus, you might call it constructor with same path multiple times.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nd">@users_route</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span> <span class="o">...</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="nd">@users_route</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">put</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_user</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">UserUpdate</span><span class="p">):</span> <span class="o">...</span>
</code></pre></div>
<p>here both <code>get_user</code> and <code>update_user</code> are under the same route.</p>
<h4 id="the-root-route">The root route</h4>
<p>an route with path <code>/</code> is the root route, if not provided, root route is created with <code>Lihil</code> by default, anything registered via <code>Lihil.{http method}</code> is the under the root route.</p>
<h3 id="websocket">WebSocket</h3>
<p>lihil supports the usage of websocket, you might use <code>WebSocketRoute.ws_handler</code> to register a function that handles websockets.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">WebSocketRoute</span><span class="p">,</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">Ignore</span><span class="p">,</span> <span class="n">use</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="n">ws_route</span> <span class="o">=</span> <span class="n">WebSocketRoute</span><span class="p">(</span><span class="s2">&quot;web_socket/</span><span class="si">{session_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ws_factory</span><span class="p">(</span><span class="n">ws</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ignore</span><span class="p">[</span><span class="n">AsyncResource</span><span class="p">[</span><span class="n">WebSocket</span><span class="p">]]:</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>    <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>    <span class="k">yield</span> <span class="n">ws</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>    <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="nd">@ws_route</span><span class="o">.</span><span class="n">ws_handler</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ws_handler</span><span class="p">(</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>    <span class="n">ws</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">WebSocket</span><span class="p">,</span> <span class="n">use</span><span class="p">(</span><span class="n">ws_factory</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">)],</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>    <span class="n">max_users</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="p">):</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>    <span class="k">assert</span> <span class="n">session_id</span> <span class="o">==</span> <span class="s2">&quot;session123&quot;</span> <span class="ow">and</span> <span class="n">max_users</span> <span class="o">==</span> <span class="mi">5</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>    <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">)</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="n">lhl</span> <span class="o">=</span> <span class="n">Lihil</span><span class="p">[</span><span class="kc">None</span><span class="p">]()</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="n">lhl</span><span class="o">.</span><span class="n">include_routes</span><span class="p">(</span><span class="n">ws_route</span><span class="p">)</span>
</code></pre></div>
<p>Testing
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil.vendors</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span> <span class="c1"># require httpx installed</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">lhl</span><span class="p">)</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="k">with</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="k">with</span> <span class="n">client</span><span class="o">.</span><span class="n">websocket_connect</span><span class="p">(</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>        <span class="s2">&quot;/web_socket/session123?max_users=5&quot;</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="p">)</span> <span class="k">as</span> <span class="n">websocket</span><span class="p">:</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">websocket</span><span class="o">.</span><span class="n">receive_text</span><span class="p">()</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>        <span class="k">assert</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;Hello, world!&quot;</span>
</code></pre></div></p>
<h4 id="websocket-vs-http">websocket vs http</h4>
<ul>
<li>
<p>WebSocket handlers must be asynchronous  since communication is bidirectional and event-driven, the handler must use async def to support non-blocking interaction.</p>
</li>
<li>
<p>WebSocket connections do not support request bodies in the same way as HTTP  there is no Body parameter during the handshake. All data is exchanged after the connection is established, typically through messages sent via the WebSocket protocol.</p>
</li>
<li>
<p>WebSockets are stateful  unlike HTTP, which is stateless, a WebSocket connection persists, allowing continuous communication between the client and server. This enables maintaining per-connection state (e.g. user sessions, in-memory data).</p>
</li>
<li>
<p>WebSockets use a different lifecycle  they begin with an HTTP handshake (usually a GET request), then upgrade the protocol. After that, communication is done over the WebSocket protocol, not HTTP.</p>
</li>
<li>
<p>Standard request/response patterns do not apply  WebSockets are message-based and support real-time interaction, so traditional concepts like status codes, headers per message, or body parsing dont directly apply after the initial handshake.</p>
</li>
</ul>
<h3 id="middlewares">Middlewares</h3>
<p>Both <code>Lihil</code> and <code>Route</code> has <code>add_middleware</code> API that accept one, or a sequence of <code>MiddlewareFactory</code>.</p>
<p>a <code>MiddlewareFactory</code> is a callable that receives one positional argument of type <code>ASGIApp</code> and returns a <code>ASGIApp</code>. for example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># This piece of code is for demonstration only.</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">tracingmw_factory</span><span class="p">(</span><span class="n">next_app</span><span class="p">:</span> <span class="n">ASGIApp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ASGIApp</span><span class="p">:</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">tracemw</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>        <span class="n">scope</span><span class="p">[</span><span class="s2">&quot;trace_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>        <span class="k">await</span> <span class="n">next_app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">)</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="k">return</span> <span class="n">trace_mw</span>
</code></pre></div>
<p>lihil uses starlette internally, you can directly import middlewares from starlette, for example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSSMiddleware</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">lhl</span> <span class="o">=</span> <span class="n">Lihil</span><span class="p">(</span><span class="n">middlewares</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">app</span><span class="p">:</span> <span class="n">CORSMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">add_methods</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)])</span>
</code></pre></div>
<p>for complex middleware that require many external dependencies, you might to construct them inside lifespan.</p>
<h2 id="config-your-app">Config Your App</h2>
<p>There are several settings you can change to control the behavior of lihil,</p>
<ol>
<li>
<p>config file, e.g: <code>pyproject.toml</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">lhl</span> <span class="o">=</span> <span class="n">Lihil</span><span class="p">(</span><span class="n">config_file</span><span class="o">=</span><span class="s2">&quot;pyproject.toml&quot;</span><span class="p">)</span>
</code></pre></div>
<p>This will look for <code>tool.lihil</code> table in the <code>pyproject.toml</code> file
extra/unkown keys will be forbidden to help prevent misconfiging</p>
<p>Note: currently only toml file is supported</p>
</li>
<li>
<p><code>AppConfig</code> instance</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">lhl</span> <span class="o">=</span> <span class="n">Lihil</span><span class="p">(</span><span class="n">app_config</span><span class="o">=</span><span class="n">AppConfig</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s2">&quot;0.1.1&quot;</span><span class="p">))</span>
</code></pre></div>
<p>this is particularly useful if you want to inherit from AppConfig and extend it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppConfig</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">MyConfig</span><span class="p">(</span><span class="n">AppConfig</span><span class="p">):</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>    <span class="n">app_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="n">config</span> <span class="o">=</span> <span class="n">MyConfig</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s2">&quot;myconfig.toml&quot;</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>Command line arguments:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>python app.py --oas.title &quot;New Title&quot; --is_prod true
</code></pre></div>
<ul>
<li>
<p>use <code>.</code> to express nested fields</p>
</li>
<li>
<p>add <code>--help</code> to see available options</p>
</li>
</ul>
</li>
</ol>
<p>You can access <code>AppConfig</code> anywhere in your app via <code>lihil.config.lhl_get_config</code></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">lhl_get_config</span><span class="p">,</span> <span class="n">AppConfig</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="n">app_config</span><span class="p">:</span> <span class="n">AppConfig</span> <span class="o">=</span> <span class="n">lhl_get_config</span><span class="p">()</span>
</code></pre></div>
<h2 id="error-hanlding">Error Hanlding</h2>
<ul>
<li>use <code>route.get(errors=VioletsAreBlue)</code> to declare a endpoint response</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">VioletsAreBlue</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>    <span class="s2">&quot;how about you?&quot;</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>    <span class="n">__status__</span> <span class="o">=</span> <span class="mi">418</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="nd">@lhl</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="n">VioletsAreBlue</span><span class="p">)</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">roses_are_red</span><span class="p">():</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>    <span class="k">raise</span> <span class="n">VioletsAreBlue</span><span class="p">(</span><span class="s2">&quot;I am a pythonista&quot;</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>use <code>lihil.problems.problem_solver</code> as decorator to register a error handler, error will be parsed as Problem Detail.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil.problems</span><span class="w"> </span><span class="kn">import</span> <span class="n">problem_solver</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="c1"># NOTE: you can use type union for exc, e.g. UserNotFound | status.NOT_FOUND</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="nd">@problem_solver</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">handle_404</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">404</span><span class="p">]):</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;resource not found&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">)</span>
</code></pre></div>
<p>A solver that handles a specific exception type (e.g., <code>UserNotFound</code>) takes precedence over a solver that handles the status code (e.g., <code>404</code>).</p>
<h3 id="exception-problem-mapping">Exception-Problem mapping</h3>
<p>lihil automatically generates a response and documentation based on your HTTPException,
Here is the generated doc for the endpoint <code>roses_are_red</code></p>
<p><img alt="roses_are_red" src="../images/roses_are_red_link.png" /></p>
<p>click url under <code>External documentation</code> tab</p>
<p>we will see the detailed problem page</p>
<p><img alt="problem page" src="../images/roses_are_red_problempage.png" /></p>
<p>By default, every endpoint will have at least one response with code <code>422</code> for <code>InvalidRequestErrors</code>.</p>
<p>Here is one example response of <code>InvalidRequestErrors</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="p">{</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">  </span><span class="nt">&quot;type_&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;invalid-request-errors&quot;</span><span class="p">,</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">422</span><span class="p">,</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">  </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Missing&quot;</span><span class="p">,</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">  </span><span class="nt">&quot;detail&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;MissingRequestParam&quot;</span><span class="p">,</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">      </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;query&quot;</span><span class="p">,</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">      </span><span class="nt">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;q&quot;</span><span class="p">,</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Param is Missing&quot;</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;MissingRequestParam&quot;</span><span class="p">,</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">      </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;query&quot;</span><span class="p">,</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">      </span><span class="nt">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a><span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Param is Missing&quot;</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">  </span><span class="p">],</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">  </span><span class="nt">&quot;instance&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/users&quot;</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="p">}</span>
</code></pre></div>
<ul>
<li>To alter the creation of the response, use <code>lihil.problems.problem_solver</code> to register your solver.</li>
<li>To change the documentation, override <code>DetailBase.__json_example__</code> and <code>DetailBase.__problem_detail__</code>.</li>
<li>To extend the error detail, provide typevar when inheriting <code>HTTPException[T]</code>.</li>
</ul>
<h2 id="message-system">Message System</h2>
<p>Lihil has built-in support for both in-process message handling (Beta) and out-of-process message handling (implementing), it is recommended to use <code>EventBus</code> over <code>BackGroundTask</code> for event handling.</p>
<p>There are three primitives for event:</p>
<ol>
<li>publish: asynchronous and blocking event handling that shares the same scope with caller.</li>
<li>emit: non-blocking asynchrounous event hanlding, has its own scope.</li>
<li>sink: a thin wrapper around external dependency for data persistence, such as message queue or database.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resp</span><span class="p">,</span> <span class="n">Route</span><span class="p">,</span> <span class="n">status</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil.plugins.bus</span><span class="w"> </span><span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">EventBus</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil.plugins.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalClient</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">TodoCreated</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">listen_create</span><span class="p">(</span><span class="n">created</span><span class="p">:</span> <span class="n">TodoCreated</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>    <span class="k">assert</span> <span class="n">created</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>    <span class="k">assert</span> <span class="n">created</span><span class="o">.</span><span class="n">content</span>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">listen_twice</span><span class="p">(</span><span class="n">created</span><span class="p">:</span> <span class="n">TodoCreated</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>    <span class="k">assert</span> <span class="n">created</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>    <span class="k">assert</span> <span class="n">created</span><span class="o">.</span><span class="n">content</span>
<a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>
<a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>
<a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a><span class="n">bus_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/bus&quot;</span><span class="p">,</span> <span class="n">listeners</span><span class="o">=</span><span class="p">[</span><span class="n">listen_create</span><span class="p">,</span> <span class="n">listen_twice</span><span class="p">])</span>
<a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>
<a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>
<a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a><span class="nd">@bus_route</span><span class="o">.</span><span class="n">post</span>
<a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_todo</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="n">EventBus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Resp</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">OK</span><span class="p">]:</span>
<a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a>    <span class="k">await</span> <span class="n">bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">TodoCreated</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
</code></pre></div>
<p>An event can have multiple event handlers, they will be called in sequence, config your <code>BusTerminal</code> with <code>publisher</code> then inject it to <code>Lihil</code>.</p>
<ul>
<li>
<p>An event handler can have as many dependencies as you want, but it should at least contain two params: a sub type of <code>Event</code>, and a sub type of <code>MessageContext</code>.</p>
</li>
<li>
<p>if a handler is reigstered with a parent event, it will listen to all of its sub event.
for example,</p>
</li>
<li>
<p>a handler that listens to <code>UserEvent</code>, will also be called when <code>UserCreated(UserEvent)</code>, <code>UserDeleted(UserEvent)</code> event is published/emitted.</p>
</li>
<li>
<p>you can also publish event during event handling, to do so, declare one of your dependency as <code>EventBus</code>,</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">listen_create</span><span class="p">(</span><span class="n">created</span><span class="p">:</span> <span class="n">TodoCreated</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="n">EventBus</span><span class="p">):</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>    <span class="k">if</span> <span class="n">is_expired</span><span class="p">(</span><span class="n">created</span><span class="o">.</span><span class="n">created_at</span><span class="p">):</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>        <span class="n">event</span> <span class="o">=</span> <span class="n">TodoExpired</span><span class="o">.</span><span class="n">from_event</span><span class="p">(</span><span class="n">created</span><span class="p">)</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>        <span class="k">await</span> <span class="n">bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div>
<h3 id="dependency-injection">Dependency Injection</h3>
<p>lihil uses ididi(https://lihil.cc/ididi) for dependency injection.</p>
<h4 id="usage-in-lihil">Usage in lihil</h4>
<h4 id="register-a-dependency-with-a-route">register a dependency with a route</h4>
<p>If a dependency is registered with any route, it will be available in every route included in <code>Lihil</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Engine</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_engine</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Engine</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="n">user_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/user&quot;</span><span class="p">)</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="n">user_route</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">get_engine</span><span class="p">)</span> <span class="c1"># register Engine as a dependency in user_route</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="n">order_route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/order&quot;</span><span class="p">)</span> <span class="c1"># order will use `get_engine` to resolve `Engine` as well.</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="n">lhl</span> <span class="o">=</span> <span class="n">Lihil</span><span class="p">(</span><span class="n">routes</span><span class="o">=</span><span class="p">[</span><span class="n">user_route</span><span class="p">,</span> <span class="n">order_route</span><span class="p">])</span>
</code></pre></div>
<ul>
<li>use <code>Route.factory</code> to add a dependency, or <code>Route.add_nodes</code> to add many dependencies.</li>
<li>It is recommended to register dependency where you use them, but you can register them to any route if you want.</li>
<li>You might create a <code>ididi.Graph</code> first, register dependencies with it, then inject it into any route.</li>
</ul>
<h4 id="declare-dependency-with-endpoint-signature">Declare dependency with endpoint signature</h4>
<p>If you would like to declare dependencies directly in your endpoint function:
(as opposed to register with route)</p>
<h5 id="use-lihiluse-mark-to-declare-a-class-as-a-dependency">Use <code>lihil.Use</code> mark to declare a class as a dependency.</h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">route</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">)</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="nd">@route</span><span class="o">.</span><span class="n">get</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Use</span><span class="p">[</span><span class="n">Engine</span><span class="p">])</span> <span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<h5 id="use-typingannotatedt-usecallable-t-to-declare-a-factory-in-your-endpoint">Use <code>typing.Annotated[T, use(Callable[..., T]])</code> to declare a factory in your endpoint</h5>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">lihil</span><span class="w"> </span><span class="kn">import</span> <span class="n">use</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="nd">@route</span><span class="o">.</span><span class="n">get</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Engine</span><span class="p">,</span> <span class="n">use</span><span class="p">(</span><span class="n">get_engine</span><span class="p">)])</span> <span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<h5 id="use-ignore-in-return-annotation-to-declare-a-function-dependencies">Use <code>Ignore</code> in return annotation to declare a function dependencies</h5>
<p>You can create function as dependency by <code>Annotated[Any, use(your_function)]</code>. Do note that you will need to annotate your dependency function return type with <code>Ignore</code> like this</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">UserToken</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Ignore</span><span class="p">[</span><span class="n">User</span><span class="p">]:</span> <span class="o">...</span>
</code></pre></div>
<h4 id="tehcnical-details">Tehcnical details</h4>
<ul>
<li>
<p>If your factory function is a generator(function that contains <code>yield</code> keyword), it will be treated as <code>scoped</code>, meaning that it will be created before your endpoint function and destoried after. you can use this to achieve business purpose via clients that offer <code>atomic operation</code>, such as database connection.</p>
</li>
<li>
<p>if your function is a sync generator, it will be solved within a separate thread.</p>
</li>
<li>
<p>all graph will eventually merged into the main graph holding by <code>Lihil</code>, which means that, if you register a dependency with a factory in route <code>A</code>, the same factory can be used in every other route if it is required.</p>
</li>
</ul>
<h3 id="have-not-found-what-you-are-looking-for">Have not found what you are looking for?</h3>
<p>please let us know by posting in the discussion.</p>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.github.com/raceychan" target="_blank" rel="noopener" title="www.github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>